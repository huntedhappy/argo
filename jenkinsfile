pipeline {
  environment {
    // the address of your harbor registry
    REGISTRY = 'https://harbor.tkg.io'
    // the project name
    // make sure your robot account have enough access to the project
    HARBOR_PROJECTS = 'library'
    // docker image name
    APP_NAME = 'docker-example'
    // ‘robot-test’ is the credential ID you created on the KubeSphere console
    HARBOR_CREDENTIAL = 'dockerhub'
    // which is git hub docker file 
    dockerfile = 'nginx/backend/Dockerfile'
  }
  agent any
  stages {
    stage('Cloning Git') {
      steps{
        checkout scm
      }
    }
    stage('Building Docker Image') {
      steps{
        script {
          dockerImage = docker.build("$HARBOR_PROJECTS/$APP_NAME", "-f $dockerfile .")
        }
      }
    }
    stage("install in Docker"){
      steps {
          sh 'whoami'
      }
    }	
    stage('PUSH PRIVATE HARBOR') {
      steps {
        script {      
          docker.withRegistry ('https://harbor.tkg.io', HARBOR_CREDENTIAL) {
          dockerImage.push('${BUILD_NUMBER}')
          dockerImage.push("latest")
          }
        } 
      }
    }
    stage('Manifest version change') {
      steps {
        script {      
          sh 'cd /var/tmp/argo && sh rollout.sh ${BUILD_NUMBER}'
        }
      } 
    }
    stage('Check File change') {
      steps {
        script {          
          SCM_VARS = git branch: 'main', url: 'https://github.com/huntedhappy/argo.git'
          CHANGE = sh(script: "git diff ${SCM_VARS.GIT_PREVIOUS_SUCCESSFUL_COMMIT} ${SCM_VARS.GIT_COMMIT} nginx1.yaml", returnStdout: true)
          sh 'echo $CHANGE'
          if (CHANGE.length() > 0) { 
            sh 'cd /var/tmp/argo'
            sh 'git add nginx1.yaml'
            sh 'git commit -m "manifest chage"'
            sh 'git merge main'
            sh 'git push origin main'
            sh 'echo "nginx1.yaml is change"'
          }
    	  } 
      } 
    }
  }    
}
