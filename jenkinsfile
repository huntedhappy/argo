pipeline {
  environment {
    // the address of your harbor registry
    REGISTRY = 'https://harbor.tkg.io'
    // the project name
    // make sure your robot account have enough access to the project
    HARBOR_PROJECTS = 'library'
    // docker image name
    APP_NAME = 'docker-example'
    // ‘robot-test’ is the credential ID you created on the KubeSphere console
    HARBOR_CREDENTIAL = 'dockerhub'
    // which is git hub docker file 
    dockerfile = 'nginx/backend/Dockerfile'
  }
  agent any
  parameters {
    imageTag(name: 'DOCKER_IMAGE', description: '',
             image: 'jenkins/jenkins', filter: 'lts.*', defaultTag: 'lts-jdk11',
             registry: 'https://harbor.tkg.io', credentialId: '', tagOrder: 'NATURAL')
  }
  stages {
    stage('Cloning Git') {
      steps{
        checkout scm
      }
    }
    stages {
      stage('Test') {
        steps {
          echo "$DOCKER_IMAGE" // will print selected image name with tag (eg. jenkins/jenkins:lts-jdk11)
          echo "$DOCKER_IMAGE_TAG" // will print selected tag value (eg. lts-jdk11)
          echo "$DOCKER_IMAGE_IMAGE" // will print selected image name value (eg. jenkins/jenkins)
        }
      }
    }    
    stage('Building Docker Image') {
      steps{
        script {
          dockerImage = docker.build("$DOCKER_IMAGE", "-f $dockerfile .")
        }
      }
    }
    stage("install helm in Docker"){
      steps {
          sh 'whoami'
      }
    }	
    stage('PUSH PRIVATE HARBOR') {
      steps {
        script {      
          docker.withRegistry ('https://harbor.tkg.io', HARBOR_CREDENTIAL) {
          dockerImage.push('${DOCKER_IMAGE_TAG}')
          dockerImage.push("latest")
          }
        } 
      }
    }
  }
}
