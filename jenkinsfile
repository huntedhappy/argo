pipeline {
  environment {
    // the address of your harbor registry
    REGISTRY = 'https://harbor.tkg.io'
    // the project name
    // make sure your robot account have enough access to the project
    HARBOR_PROJECTS = 'library'
    // docker image name
    APP_NAME = 'docker-example'
    // ‘robot-test’ is the credential ID you created on the KubeSphere console
    HARBOR_CREDENTIAL = 'dockerhub'
    // which is git hub docker file 
    dockerfile = 'nginx/backend/Dockerfile'
    
    GIT_AUTH = credentials('188e20e1-dfca-4b98-98c4-734b0732c528')    
  }
  agent any
  stages {
    stage('Cloning Git') {
      steps{
        checkout scm
      }
    }
    stage('Building Docker Image') {
      steps{
        script {
          dockerImage = docker.build("$HARBOR_PROJECTS/$APP_NAME", "-f $dockerfile .")
        }
      }
    }
    stage("install in Docker"){
      steps {
          sh 'whoami'
      }
    }	
    stage('PUSH PRIVATE HARBOR') {
      steps {
        script {      
          docker.withRegistry ('https://harbor.tkg.io', HARBOR_CREDENTIAL) {
          dockerImage.push('${BUILD_NUMBER}')
          dockerImage.push("latest")
          }
        } 
      }
    }
    stage('Manifest version change') {
      steps {
        script {      
          sh 'cd /var/tmp/argo && sh rollout.sh ${BUILD_NUMBER}'
        }
      } 
    }
    stage('Check File change') {
      steps {
        sh('''
          git config --local credential.helper "!f() { echo username=\\$GIT_AUTH_USR; echo password=\\$GIT_AUTH_PSW; }; f"
          git push origin main
        ''')
      }
    }
  }    
}
